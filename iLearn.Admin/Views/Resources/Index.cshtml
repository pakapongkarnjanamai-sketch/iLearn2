@{
    ViewBag.Title = "Resources";
}

<style>
    .uploader-container {
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 20px;
        border: 1px dashed #ced4da;
    }
    .note {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 10px;
        display: block;
    }
</style>

<div class="container-fluid page-full-height">

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@ViewBag.Title List</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Resource Type for Upload:</label>
                        <div id="uploadTypeSelect"></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div id="fileUploader"></div>
                    <span class="note">Supported: <b>.zip (SCORM)</b> | Max size: 100MB</span>
                </div>
            </div>
            <div id="grid"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const resourceTypes = [
            { id: 1, name: 'Learn' },
            { id: 2, name: 'Exam' }
        ];

        // ค่า Default สำหรับการอัปโหลด
        let selectedUploadTypeId = 1;

        $(() => {

            // 1. ตัวเลือกประเภทไฟล์ก่อนอัปโหลด
            $("#uploadTypeSelect").dxSelectBox({
                dataSource: resourceTypes,
                valueExpr: 'id',
                displayExpr: 'name',
                value: selectedUploadTypeId,
                onValueChanged: function(e) {
                    selectedUploadTypeId = e.value;
                    // อัปเดต URL ของ Uploader เมื่อเปลี่ยนประเภท
                    const uploader = $("#fileUploader").dxFileUploader("instance");
                    uploader.option("uploadUrl", getUploadUrl());
                }
            });

            function getUploadUrl() {
                return `${serviceUrl}/Resources/upload?typeId=${selectedUploadTypeId}`;
            }

            // 2. File Uploader Configuration
                   $("#fileUploader").dxFileUploader({
            name: 'file',
            multiple: true,
            accept: '.zip',
            uploadMode: 'instantly',
            // uploadUrl: getUploadUrl(), <--- ลบบรรทัดนี้ออก (เราจะใช้ uploadFile แทน)
            maxFileSize: 100 * 1024 * 1024, // 100MB

            // --- ใช้ Custom Upload แทน ---
            uploadFile: function(file, progressCallback) {
                var deferred = $.Deferred();
                var formData = new FormData();
                formData.append("file", file); // ชื่อ Parameter ต้องตรงกับที่ API รับ (เช่น IFormFile file)

                var xhr = new XMLHttpRequest();
                // ดึง URL ล่าสุดจากฟังก์ชัน
                var url = getUploadUrl();

                xhr.open("POST", url, true);

                // จุดสำคัญ: ตั้งค่า Credentials ทันทีหลัง open()
                xhr.withCredentials = true;

                // ตั้งค่า Progress Bar
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        progressCallback(e.loaded, e.total);
                    }
                };

                // ตรวจสอบผลลัพธ์เมื่อเสร็จสิ้น
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        deferred.resolve(); // สำเร็จ
                    } else {
                        deferred.reject(xhr.responseText || xhr.statusText); // แจ้ง Error
                    }
                };

                xhr.onerror = function() {
                    deferred.reject("Network Error");
                };

                xhr.send(formData);

                return deferred.promise();
            },
            // ---------------------------

            // ไม่ต้องใช้ onUploadStarted แล้ว
            // onUploadStarted: ...

            onUploaded: function (e) {
                DevExpress.ui.notify("File uploaded successfully", "success", 2000);
                $("#grid").dxDataGrid("instance").refresh();
            },
            onUploadError: function (e) {
                let msg = "Upload failed";
                // ปรับการดึง Error message จาก Custom Upload (e.error จะเป็น string ที่เรา reject)
                if (e.error) {
                     msg = e.error;
                }
                console.error("Upload Error:", e);
                DevExpress.ui.notify(msg, "error", 3000);
            }
        });

            // 3. DataGrid Configuration
            const grid = $("#grid").dxDataGrid({
                dataSource: createDataStore(serviceUrl, 'admin/ResourcesCRUD', {
                    key: 'Id',
                }),
                remoteOperations: true,
                columnAutoWidth: true,
                showBorders: true,
                scrolling: { mode: "virtual" },
                height: "Auto",
                headerFilter: { visible: true, search: { enabled: true } },
                searchPanel: { visible: true, width: 300, placeholder: "Search resources..." },

                editing: {
                    mode: "popup",
                    allowUpdating: true,
                    allowDeleting: true,
                    allowAdding: false, // ให้เพิ่มผ่านการ Upload แทนการกดปุ่ม Add
                    useIcons: true,
                    popup: {
                        title: "Resource Info",
                        showTitle: true,
                        width: 700,
                        height: 600
                    },
                    form: {
                        items: [
                            {
                                itemType: 'group',
                                caption: "General Info",
                                colCount: 2,
                                colSpan: 2,
                                items: [
                                    { dataField: 'Id', editorOptions: { disabled: true } },
                                    { dataField: 'IsActive' },
                                    {
                                        dataField: 'Name',
                                        colSpan: 2,
                                        validationRules: [{ type: "required" }]
                                    },
                                    {
                                        dataField: 'TypeId',
                                        editorType: "dxSelectBox",
                                        editorOptions: {
                                            dataSource: resourceTypes,
                                            valueExpr: 'id',
                                            displayExpr: 'name'
                                        },
                                        validationRules: [{ type: "required" }]
                                    }
                                ]
                            },
                           
                        ]
                    }
                },
                columns: [
                    { dataField: "Id", caption: "ID", width: 60, allowUpdating: false, sortOrder: 'desc' },
                    {
                        dataField: "Name",
                        caption: "Resource Name",
                        minWidth: 200,
                        cellTemplate: function(container, options) {
                            // แสดง Icon ตามนามสกุลไฟล์
                            let icon = '<i class="far fa-file"></i>';
                            if(options.data.Name.endsWith('.zip')) icon = '<i class="far fa-file-archive text-warning"></i>';
                            else if(options.data.Name.endsWith('.pdf')) icon = '<i class="far fa-file-pdf text-danger"></i>';
                            else if(options.data.Name.endsWith('.mp4')) icon = '<i class="far fa-file-video text-info"></i>';

                            container.html(`${icon} ${options.data.Name}`);
                        }
                    },
                    {
                        dataField: "TypeId",
                        caption: "Type",
                        width: 120,
                        lookup: {
                            dataSource: resourceTypes,
                            valueExpr: 'id',
                            displayExpr: 'name'
                        }
                    },

                    // --- Virtual Column สำหรับ Course Mapping ---
                    {
                        dataField: "CourseIds",
                        caption: "Assigned Courses",
                        width: 250,
                        allowSorting: false,
                        calculateCellValue: function(rowData) {
                            if (rowData.CourseResources) {
                                return rowData.CourseResources.map(cr => cr.CourseId);
                            }
                            return [];
                        },
                        editCellTemplate: tagBoxCourseTemplate,
                        lookup: {
                            dataSource: createDataStore(serviceUrl, 'admin/CoursesCRUD', { key: 'Id' }),
                            displayExpr: 'Title', // ใช้ Title ตาม Model Course
                            valueExpr: 'Id',
                        },
                        cellTemplate: function(container, options) {
                            const items = options.value || [];
                            const text = items.map(id => options.column.lookup.calculateCellValue(id)).join(", ");
                            container.text(text).attr('title', text);
                        }
                    },
                    // -------------------------------------------

                    {
                        dataField: "IsActive",
                        caption: "Active",
                        dataType: "boolean",
                        width: 80
                    },
                            {
            type: "buttons",
            width: 120, // ขยายความกว้างเล็กน้อยเพื่อให้ปุ่มแสดงผลได้สวยงาม
            buttons: [
                // 1. ปุ่มสำหรับ Publish (แสดงเฉพาะตอนยังไม่ Active)
                {
                    hint: "Publish / Activate (Extract Zip)",
                    icon: "globe", // ใช้ icon รูปโลก หรือ 'check'
                    cssClass: "dx-icon-globe text-success", // ใส่สีเขียวให้ดูว่าเป็นปุ่มเปิดใช้งาน
                    visible: function(e) {
                        // แสดงปุ่มนี้ก็ต่อเมื่อ IsActive เป็น false
                        return !e.row.data.IsActive;
                    },
                    onClick: function(e) {
                        // เรียกฟังก์ชัน JavaScript ที่เราจะสร้างด้านล่าง
                        setResourcePublic(e.row.data.Id);
                    }
                },

                // 2. ปุ่มเดิมสำหรับเปิดดู (แสดงเฉพาะตอน Active แล้ว)
                   {
            hint: "View Content",
            icon: "video",
            visible: function(e) { return e.row.data.IsActive; },
            onClick: function(e) {
                const resource = e.row.data;
                const apiUrl = `${serviceUrl}/Resources/${resource.Id}/content`;

                // ตรวจสอบว่าเป็นไฟล์ Zip (SCORM) หรือไม่
                if (resource.Name.toLowerCase().endsWith('.zip')) {

                    // 1. เปิดหน้าต่างใหม่รอไว้ทันที (ป้องกัน Popup Blocker)
                    // ต้องทำใน Event Loop เดียวกันกับการกดปุ่ม
                    const win = window.open('about:blank', '_blank');

                    if (win) {
                        win.document.title = "Loading...";
                        win.document.body.innerHTML = "<div style='text-align:center;margin-top:20%;font-family:sans-serif;'>Loading content, please wait...</div>";
                    }

                    // 2. เรียก AJAX ไปดึง URL ตัวจริงจาก JSON
                    $.ajax({
                        url: apiUrl,
                        method: "GET",
                        xhrFields: { withCredentials: true }, // ส่ง Cookie Auth ไปด้วย
                        success: function(response) {
                            if (response && response.url) {
                                // 3. ได้ URL แล้ว สั่ง Redirect หน้าต่างที่เปิดรอไว้
                                if (win) win.location.href = response.url;
                            } else {
                                if (win) win.close(); // ปิดถ้าไม่มี URL
                                DevExpress.ui.notify("Content URL not found", "error", 3000);
                            }
                        },
                        error: function(err) {
                            if (win) win.close(); // ปิดถ้า Error
                            console.error(err);
                            DevExpress.ui.notify("Failed to load content information", "error", 3000);
                        }
                    });

                } else {
                    // กรณีไฟล์ทั่วไป (PDF, MP4) ที่ API ส่งไฟล์กลับมาโดยตรง ให้เปิดได้เลย
                    window.open(apiUrl, '_blank');
                }
            }
        },
                "edit",
                "delete"
            ]
        }
                ],
            }).dxDataGrid('instance');

            // Template สำหรับ TagBox เลือกวิชา
            function tagBoxCourseTemplate(cellElement, cellInfo) {
                return $('<div>').dxTagBox({
                    dataSource: createDataStore(serviceUrl, 'admin/CoursesCRUD', { key: 'Id' }),
                    value: cellInfo.value || [],
                    valueExpr: 'Id',
                    displayExpr: 'Title', // ใช้ Title
                    showSelectionControls: true,
                    maxDisplayedTags: 3,
                    showMultiTagOnly: false,
                    applyValueMode: 'useButtons',
                    searchEnabled: true,
                    placeholder: "Assign to courses...",
                    onValueChanged(e) {
                        cellInfo.setValue(e.value);
                    },
                    onSelectionChanged(e) {
                        cellInfo.component.updateDimensions();
                    }
                });
            }

                    function setResourcePublic(id) {
            // 1. ถามยืนยันก่อนการแตกไฟล์
            var confirmDialog = DevExpress.ui.dialog.confirm(
                "<i>Are you sure you want to publish this resource?</i><br>For .zip (SCORM) files, this will extract content and make it ready.",
                "Confirm Publish"
            );

            confirmDialog.done(function(dialogResult) {
                if (dialogResult) {
                    // 2. แสดง Notification ว่ากำลังทำงาน
                    DevExpress.ui.notify("Processing... Please wait.", "info", 2000);

                    // 3. เรียก API SetPublic
                    // URL ตรงกับ Controller: [HttpPost("SetPublic")] public async Task<IActionResult> SetPublic([FromQuery] int key)
                    $.ajax({
                        url: `${serviceUrl}/Resources/SetPublic?key=${id}`,
                        type: "POST",
                        xhrFields: {
                            withCredentials: true // สำคัญ: ต้องส่ง Auth Cookie ไปด้วย
                        },
                        success: function(res) {
                            DevExpress.ui.notify("Resource activated successfully!", "success", 2000);
                            // 4. รีเฟรชตารางเพื่ออัปเดตสถานะปุ่มจาก "Globe" เป็น "Video"
                            $("#grid").dxDataGrid("instance").refresh();
                        },
                        error: function(xhr) {
                            let msg = "Activation failed";
                            if (xhr.responseText) msg = xhr.responseText;
                            DevExpress.ui.notify(msg, "error", 3000);
                            console.error(xhr);
                        }
                    });
                }
            });
        }
        })
    </script>
}