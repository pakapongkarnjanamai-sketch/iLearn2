@using iLearn.Domain.Enums
@{
    ViewData["Title"] = "สร้างหลักสูตรใหม่ (Create Course)";
    Layout = "_DevExtremeLayout";

    // แปลง Enum CourseType เป็น JSON
    var courseTypes = Html.GetEnumSelectList<CourseType>()
        .Select(e => new { id = int.Parse(e.Value), text = e.Text });
}

@* --- ส่วน Header --- *@
<div class="container mt-4 mb-5">
    <div class="qcs-card mb-3">
        <div class="row align-items-center g-3">
            <div class="col-12 col-xl me-auto">
                <h5 class="m-0 d-flex align-items-center text-primary-header">
                    <i class="fas fa-book-open me-2 flex-shrink-0" style="color: var(--dx-primary-color);"></i>
                    <div class="text-wrap lh-sm">
                        <span class="fw-bold">@ViewData["Title"]</span>
                    </div>
                </h5>
            </div>
            <div class="col-12 col-xl-auto">
                <div id="actionButtons"></div>
            </div>
        </div>
    </div>

    @* --- ส่วน Form Container (dxForm) --- *@
    <div class="qcs-card">
        <div id="dxFormContainer"></div>
    </div>
</div>
@section Scripts {
    <script>
        $(function () {
            const courseTypeData = @Html.Raw(Json.Serialize(courseTypes));

            // ตัวแปรเก็บ ID แยกตามประเภท
            let selectedLearnIds = [];
            let selectedExamIds = [];

       
            const resourceStore = createDataStore(serviceUrl, "admin/ResourcesCRUD");

            const categoryDataSource = createDataStore(serviceUrl, "admin/CategoriesCRUD");

            // --- ฟังก์ชันสร้าง Grid Settings (คงเดิม) ---
            function createGridConfig(typeId, onSelectionChangeCallback) {
                return {
                    dataSource: {
                        store: resourceStore,
                        filter: ["TypeId", "=", typeId] // กรองข้อมูล: 1=Learn, 2=Exam
                    },
                    keyExpr: "Id",
                    showBorders: true,
                    height: 300,
                    selection: { mode: "multiple", showCheckBoxesMode: "always" },
                    searchPanel: { visible: true, width: 200 },
                    scrolling: { mode: "virtual" },
                    columns: [
                        { dataField: "Name", caption: "Resource Name" },
                        { dataField: "IsActive", dataType: "boolean", width: 80, caption: "Active" }
                    ],
                    onSelectionChanged: onSelectionChangeCallback
                };
            }

            // --- สร้าง dxForm ---
            const formInstance = $("#dxFormContainer").dxForm({
                formData: { CourseType: 1 },
                labelMode: "floating",
                validationGroup: "courseGroup",
                items: [
                    {
                        itemType: "group",
                        caption: "ข้อมูลทั่วไป (General Information)",
                        colCount: 2,
                        items: [
                            {
                                dataField: "CourseCode",
                                label: { text: "รหัสวิชา" },
                                editorType: "dxTextBox",
                                validationRules: [{ type: "required", message: "กรุณาระบุรหัสวิชา" }]
                            },
                            {
                                dataField: "CourseName",
                                label: { text: "ชื่อวิชา" },
                                editorType: "dxTextBox",
                                validationRules: [{ type: "required", message: "กรุณาระบุชื่อวิชา" }]
                            },
                            {
                                dataField: "CourseType",
                                label: { text: "ประเภทหลักสูตร" },
                                editorType: "dxSelectBox",
                                editorOptions: {
                                    dataSource: courseTypeData,
                                    valueExpr: "id",
                                    displayExpr: "text"
                                },
                                validationRules: [{ type: "required" }]
                            },
                            {
                                dataField: "CategoryId",
                                label: { text: "หมวดหมู่" },
                                editorType: "dxSelectBox",
                                editorOptions: {
                                    dataSource: categoryDataSource, // ✅ ใช้ตัวแปรที่สร้างจาก createDataStore
                                    valueExpr: "Id",
                                    displayExpr: "Name",
                                    showClearButton: true
                                }
                            }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "รายละเอียด (Detail)",
                        colCount: 1,
                        items: [
                            {
                                dataField: "Description",
                                label: { text: "รายละเอียด" },
                                editorType: "dxTextArea",
                                editorOptions: { height: 100 }
                            }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "เอกสารประกอบ (Resources)",
                        colCount: 2,
                        items: [
                            // --- ส่วนที่ 1: Learn Resources ---
                            {
                                template: function (data, itemElement) {
                                    itemElement.append(
                                        $("<div class='p-2 border rounded bg-light'>").append(
                                            $("<h6 class='fw-bold text-primary mb-2'>")
                                                .html('<i class="fas fa-book-reader me-1"></i> สื่อการเรียนรู้ (Learn)'),
                                            $("<div>").attr("id", "gridLearn")
                                        )
                                    );

                                    setTimeout(() => {
                                        $("#gridLearn").dxDataGrid(createGridConfig(1, (e) => {
                                            selectedLearnIds = e.selectedRowsData.map(r => r.Id);
                                        }));
                                    }, 0);
                                }
                            },
                            // --- ส่วนที่ 2: Exam Resources ---
                            {
                                template: function (data, itemElement) {
                                    itemElement.append(
                                        $("<div class='p-2 border rounded bg-light'>").append(
                                            $("<h6 class='fw-bold text-danger mb-2'>")
                                                .html('<i class="fas fa-pen-alt me-1"></i> แบบทดสอบ (Exam)'),
                                            $("<div>").attr("id", "gridExam")
                                        )
                                    );

                                    setTimeout(() => {
                                        $("#gridExam").dxDataGrid(createGridConfig(2, (e) => {
                                            selectedExamIds = e.selectedRowsData.map(r => r.Id);
                                        }));
                                    }, 0);
                                }
                            }
                        ]
                    }
                ]
            }).dxForm("instance");

            // --- ปุ่ม Save / Cancel ---
            const btnGroup = $("<div>").addClass("d-flex gap-2");

            $("<div>").dxButton({
                text: "บันทึก (Save)",
                icon: "save",
                type: "default",
                stylingMode: "contained",
                onClick: submitForm
            }).appendTo(btnGroup);

            $("<div>").dxButton({
                text: "ยกเลิก (Cancel)",
                icon: "close",
                type: "normal",
                stylingMode: "text",
                onClick: () => window.location.href = '@Url.Action("Index", "Courses")'
            }).appendTo(btnGroup);

            $("#actionButtons").append(btnGroup);

            // --- ฟังก์ชัน Submit Form ---
            function submitForm() {
                const validateResult = formInstance.validate();
                if (!validateResult.isValid) {
                    DevExpress.ui.notify("กรุณากรอกข้อมูลให้ครบถ้วน", "error", 2000);
                    return;
                }

                const allResourceIds = [...selectedLearnIds, ...selectedExamIds];
                const formDataObj = formInstance.option("formData");

                const dataToSend = {
                    CourseCode: formDataObj.CourseCode,
                    CourseName: formDataObj.CourseName,
                    Description: formDataObj.Description,
                    CourseType: formDataObj.CourseType,
                    CategoryId: formDataObj.CategoryId,
                    ResourceIds: allResourceIds
                };

                DevExpress.ui.notify("กำลังบันทึกข้อมูล...", "info", 1000);

                $.ajax({
                    url: serviceUrl + "/Courses/Create",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(dataToSend),
                    // headers: {
                    //     "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                    // },
                    xhrFields: { withCredentials: true },
                    success: function (response) {
                        DevExpress.ui.notify("บันทึกสำเร็จ!", "success", 2000);
                        setTimeout(() => window.location.href = '@Url.Action("Index", "Courses")', 1000);
                    },
                    error: function (xhr) {
                        let msg = "เกิดข้อผิดพลาดในการบันทึก";
                        if(xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                        DevExpress.ui.notify(msg, "error", 3000);
                    }
                });
            }
        });
    </script>
}