@using iLearn.Domain.Enums
@{
    ViewData["Title"] = "สร้างหลักสูตรใหม่ (Create Course)";
    Layout = "_DevExtremeLayout";

    // 1. แปลง Enum CourseType เป็น JSON สำหรับ JavaScript
    var courseTypes = Html.GetEnumSelectList<CourseType>()
        .Select(e => new { id = int.Parse(e.Value), text = e.Text });
}

@* --- ส่วน Header --- *@
<div class="container mt-4 mb-5">
    <div class="qcs-card mb-3">
        <div class="row align-items-center g-3">
            <div class="col-12 col-xl me-auto">
                <h5 class="m-0 d-flex align-items-center text-primary-header">
                    <i class="fas fa-book-open me-2 flex-shrink-0" style="color: var(--dx-primary-color);"></i>
                    <div class="text-wrap lh-sm">
                        <span class="fw-bold">@ViewData["Title"]</span>
                    </div>
                </h5>
            </div>
            <div class="col-12 col-xl-auto">
                @* ปุ่ม Action จะถูก Inject ที่นี่โดย JavaScript *@
                <div id="actionButtons"></div>
            </div>
        </div>
    </div>

    @* --- ส่วน Form Container (dxForm) --- *@
    <div class="qcs-card">
        <div id="dxFormContainer"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // รับค่า Enum จาก Razor มาเป็นตัวแปร JS
            const courseTypeData = @Html.Raw(Json.Serialize(courseTypes));

            // กำหนด URL ของ API หมวดหมู่ (ปรับตามที่คุณใช้งานจริง)
            // ถ้าคุณมีฟังก์ชัน createDataStore เหมือนใน Wizard ให้ใช้ตัวนั้นแทน
            const categoryDataSource = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: "/api/Categories/GetAll", // หรือ URL ที่ถูกต้องของคุณ
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            // --- สร้าง dxForm ---
            const formInstance = $("#dxFormContainer").dxForm({
                formData: {
                    CourseType: 1 // ค่าเริ่มต้น: General
                },
                labelMode: "floating",
                validationGroup: "courseGroup",
                items: [
                    {
                        itemType: "group",
                        caption: "ข้อมูลทั่วไป (General Information)",
                        colCount: 2,
                        items: [
                            {
                                dataField: "CourseCode",
                                label: { text: "รหัสวิชา" },
                                editorType: "dxTextBox",
                                editorOptions: {
                                    placeholder: "เช่น CS101",
                                    showClearButton: true
                                },
                                validationRules: [{ type: "required", message: "กรุณาระบุรหัสวิชา" }]
                            },
                            {
                                dataField: "CourseName",
                                label: { text: "ชื่อวิชา" },
                                editorType: "dxTextBox",
                                editorOptions: {
                                    showClearButton: true
                                },
                                validationRules: [{ type: "required", message: "กรุณาระบุชื่อวิชา" }]
                            },
                            {
                                dataField: "CourseType",
                                label: { text: "ประเภทหลักสูตร" },
                                editorType: "dxSelectBox",
                                editorOptions: {
                                    dataSource: courseTypeData,
                                    valueExpr: "id",
                                    displayExpr: "text",
                                    placeholder: "เลือกประเภท"
                                },
                                validationRules: [{ type: "required", message: "กรุณาเลือกประเภท" }]
                            },
                            {
                                // [เพิ่มเติม] ฟิลด์หมวดหมู่
                                dataField: "CategoryId",
                                label: { text: "หมวดหมู่" },
                                editorType: "dxSelectBox",
                                editorOptions: {
                                    dataSource: categoryDataSource, // เชื่อมกับ API
                                    valueExpr: "id",
                                    displayExpr: "name", // ตรวจสอบว่า API ส่งกลับมาเป็น 'name' หรือ 'text'
                                    placeholder: "เลือกหมวดหมู่",
                                    showClearButton: true
                                }
                                // ถ้าบังคับเลือกให้เอา comment ออก
                                // validationRules: [{ type: "required", message: "กรุณาเลือกหมวดหมู่" }]
                            }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "รายละเอียด (Detail)",
                        colCount: 1,
                        items: [
                            {
                                dataField: "Description",
                                label: { text: "รายละเอียด" },
                                editorType: "dxTextArea",
                                editorOptions: {
                                    height: 100
                                }
                            }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "เอกสารประกอบ (Resources)",
                        items: [
                            {
                                template: function (data, itemElement) {
                                    itemElement.append(
                                        $("<div class='mb-2'>").append(
                                            $("<label class='form-label fw-bold'>").text("ไฟล์แนบ (Attachments)"),
                                            $("<div>").dxFileUploader({
                                                elementAttr: { id: "fileUploaderResource" },
                                                selectButtonText: "เลือกไฟล์",
                                                labelText: "หรือลากไฟล์มาวางที่นี่",
                                                multiple: true,
                                                uploadMode: "useForm" // ใช้ Form Submit
                                            })
                                        )
                                    );
                                }
                            }
                        ]
                    }
                ]
            }).dxForm("instance");

            // --- สร้างปุ่ม Save / Cancel ---
            const btnGroup = $("<div>").addClass("d-flex gap-2");

            // ปุ่มบันทึก (Save)
            $("<div>").dxButton({
                text: "บันทึก (Save)",
                icon: "save",
                type: "default",
                stylingMode: "contained",
                onClick: function() {
                    submitForm();
                }
            }).appendTo(btnGroup);

            // ปุ่มยกเลิก (Cancel)
            $("<div>").dxButton({
                text: "ยกเลิก (Cancel)",
                icon: "close",
                type: "normal",
                stylingMode: "text",
                onClick: function () {
                    // กลับไปหน้า Index หรือ Dashboard
                    window.location.href = '@Url.Action("Index", "Courses")';
                }
            }).appendTo(btnGroup);

            $("#actionButtons").append(btnGroup);

            // --- ฟังก์ชัน Submit Form (AJAX) ---
            function submitForm() {
                // 1. Validate ข้อมูล
                const validateResult = formInstance.validate();
                if (!validateResult.isValid) {
                    DevExpress.ui.notify("กรุณากรอกข้อมูลให้ครบถ้วน", "error", 2000);
                    return;
                }

                // 2. ดึงค่าจาก Form
                const formDataObj = formInstance.option("formData");

                // 3. เตรียม FormData สำหรับส่งไฟล์
                const dataToSend = new FormData();

                // ใส่ข้อมูล Text
                dataToSend.append("CourseCode", formDataObj.CourseCode || "");
                dataToSend.append("CourseName", formDataObj.CourseName || "");
                dataToSend.append("Description", formDataObj.Description || "");
                dataToSend.append("CourseType", formDataObj.CourseType);

                if (formDataObj.CategoryId) {
                    dataToSend.append("CategoryId", formDataObj.CategoryId);
                }

                // ใส่ข้อมูลไฟล์ (ดึงจาก dxFileUploader โดยตรง)
                const uploaderInstance = $("#fileUploaderResource").dxFileUploader("instance");
                const files = uploaderInstance.option("value"); // ได้ array ของ File objects

                if (files && files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        // ชื่อ "Resources" ต้องตรงกับ Property ใน DTO (List<IFormFile> Resources)
                        dataToSend.append("Resources", files[i]);
                    }
                }

                // 4. ส่ง AJAX ไปยัง Controller
                DevExpress.ui.notify("กำลังบันทึกข้อมูล...", "info", 1000);

                $.ajax({
                    url: '@Url.Action("Create", "Courses")', // ไปที่ CoursesController > Action Create [POST]
                    type: 'POST',
                    data: dataToSend,
                    processData: false, // สำคัญ: ห้าม jQuery process data
                    contentType: false, // สำคัญ: ห้าม set content-type
                    headers: {
                        // ส่ง Token ป้องกัน CSRF (ถ้ามี)
                        "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        DevExpress.ui.notify("บันทึกสำเร็จ!", "success", 2000);
                        setTimeout(() => {
                            // บันทึกเสร็จแล้วให้ไปที่หน้า Index
                            window.location.href = '@Url.Action("Index", "Courses")';
                        }, 1000);
                    },
                    error: function (xhr) {
                        console.error(xhr);
                        let msg = "เกิดข้อผิดพลาดในการบันทึก";
                        if(xhr.responseJSON && xhr.responseJSON.message) {
                            msg = xhr.responseJSON.message;
                        }
                        DevExpress.ui.notify(msg, "error", 3000);
                    }
                });
            }
        });
    </script>
}